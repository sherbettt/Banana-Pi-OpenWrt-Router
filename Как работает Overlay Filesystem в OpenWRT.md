# üéØ **1. –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç Overlay Filesystem –≤ OpenWRT?**

## **–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:**
OpenWRT –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –Ω–∞–ª–æ–∂–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤—ã—Ö —Å–∏—Å—Ç–µ–º (overlayfs) –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –µ–¥–∏–Ω–æ–≥–æ –∫–æ—Ä–Ω–µ–≤–æ–≥–æ —Ä–∞–∑–¥–µ–ª–∞ –∏–∑ –¥–≤—É—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤:

```
/ (root filesystem) = overlayfs(/rom, /overlay)
```

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞:**
- **`/rom`** ‚Äî squashfs –æ–±—Ä–∞–∑, –º–æ–Ω—Ç–∏—Ä—É–µ–º—ã–π —Ç–æ–ª—å–∫–æ –¥–ª—è —á—Ç–µ–Ω–∏—è
- **`/overlay`** ‚Äî JFFS2/UBIFS —Ä–∞–∑–¥–µ–ª –¥–ª—è –∑–∞–ø–∏—Å–∏
- **`/`** ‚Äî –æ–±—ä–µ–¥–∏–Ω–µ–Ω–Ω–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ overlayfs

**–ú–µ—Ö–∞–Ω–∏–∑–º —Ä–∞–±–æ—Ç—ã:**
```bash
# –ü—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ —Ñ–∞–π–ª—É:
# 1. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –≤–µ—Ä—Ö–Ω–∏–π —Å–ª–æ–π (/overlay)
# 2. –ï—Å–ª–∏ —Ñ–∞–π–ª –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç, –±–µ—Ä–µ—Ç—Å—è –∏–∑ –Ω–∏–∂–Ω–µ–≥–æ —Å–ª–æ—è (/rom)
# 3. –ó–∞–ø–∏—Å—å –≤—Å–µ–≥–¥–∞ –æ—Å—É—â–µ—Å—Ç–≤–ª—è–µ—Ç—Å—è –≤ /overlay
```

**–ü—Ä–∏–º–µ—Ä –≤ –∫–æ–¥–µ:**
```bash
# –°–æ–∑–¥–∞–Ω–∏–µ overlayfs (—É–ø—Ä–æ—â–µ–Ω–Ω–æ)
mount -t overlay overlay -o lowerdir=/rom,upperdir=/overlay,workdir=/tmp/work /merged
```

## **–ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –∏–º–ø–ª–∏–∫–∞—Ü–∏–∏:**
- –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–∞–∫–µ—Ç–æ–≤ ‚Üí —Ñ–∞–π–ª—ã –ø–æ–º–µ—â–∞—é—Ç—Å—è –≤ `/overlay`
- –ò–∑–º–µ–Ω–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ ‚Üí –Ω–æ–≤—ã–µ –≤–µ—Ä—Å–∏–∏ –≤ `/overlay`
- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—à–∏–≤–∫–∏ ‚Üí –∑–∞–º–µ–Ω—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ `/rom`, `/overlay` —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è
- –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–µ—Ñ–æ–ª—Ç–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫ ‚Üí —É–¥–∞–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ –∏–∑ `/overlay`

---

# üîÑ **2. –ß—Ç–æ –æ–±–Ω–æ–≤–ª—è–µ—Ç .itb —Ñ–∞–π–ª –ø—Ä–∏ sysupgrade?**

## **–§–æ—Ä–º–∞—Ç .itb (FIT - Flattened Image Tree):**
`.itb` ‚Äî —ç—Ç–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç, —Å–æ–¥–µ—Ä–∂–∞—â–∏–π –Ω–µ—Å–∫–æ–ª—å–∫–æ –æ–±—Ä–∞–∑–æ–≤ —Å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º–∏:

```
openwrt_one-squashfs-sysupgrade.itb
‚îú‚îÄ‚îÄ kernel@1 (—è–¥—Ä–æ Linux —Å embedded initramfs)
‚îú‚îÄ‚îÄ fdt@1 (device tree blob –¥–ª—è –≤–∞—à–µ–≥–æ –∂–µ–ª–µ–∑–∞)
‚îî‚îÄ‚îÄ configuration@default (–æ–ø–∏—Å–∞–Ω–∏–µ —Å–±–æ—Ä–∫–∏)
```

## **–ü—Ä–æ—Ü–µ—Å—Å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:**
```bash
# –ö–æ–º–∞–Ω–¥–∞ sysupgrade –≤—ã–ø–æ–ª–Ω—è–µ—Ç:
sysupgrade -v firmware.itb
# 1. –í–∞–ª–∏–¥–∞—Ü–∏—è —Å–∏–≥–Ω–∞—Ç—É—Ä—ã/—Ö–µ—à–∞ –æ–±—Ä–∞–∑–∞
# 2. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π –∏–∑ /overlay –≤ /tmp
# 3. –ó–∞–ø–∏—Å—å –æ–±—Ä–∞–∑–∞ –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π mtd —Ä–∞–∑–¥–µ–ª (–æ–±—ã—á–Ω–æ mtd3)
# 4. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ —Å –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ–º –Ω–æ–≤–æ–π –ø—Ä–æ—à–∏–≤–∫–∏
```

## **–ó–∞—Ç—Ä–∞–≥–∏–≤–∞–µ–º—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:**
```bash
# –û–±–Ω–æ–≤–ª—è–µ—Ç—Å—è:
# - mtdblock3 (—Ä–∞–∑–¥–µ–ª —Å firmware)
# - –°–æ–¥–µ—Ä–∂–∏–º–æ–µ /rom (–ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏)

# –ù–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è:
# - mtdblock5 (—Ä–∞–∑–¥–µ–ª —Å overlay)
# - –õ—é–±—ã–µ –≤–Ω–µ—à–Ω–∏–µ storage —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ (NVMe, USB)
# - –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ (—Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –∏ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç—Å—è)
```

## **–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞:**
```bash
# –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å, –∫–∞–∫–æ–π mtd —Ä–∞–∑–¥–µ–ª –±—É–¥–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω
cat /proc/mtd 
```
```c
dev:    size   erasesize  name
mtd0: 00040000 00010000 "bl2-nor"
mtd1: 000c0000 00010000 "factory"
mtd2: 00080000 00010000 "fip-nor"
mtd3: 00c80000 00010000 "recovery"
mtd4: 00100000 00020000 "bl2"
mtd5: 0ff00000 00020000 "ubi"
```

# –ü—Ä–æ—Å–º–æ—Ç—Ä —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ .itb —Ñ–∞–π–ª–∞ (—Ç—Ä–µ–±—É–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–∫–∏ dtc)
opkg install dtc
dumpimage -l firmware.itb
```

---

# üîó **3. –°–æ–∑–¥–∞–Ω–∏–µ —Å–∏–º–ª–∏–Ω–∫–æ–≤ –Ω–∞ NVMe –¥–ª—è —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è overlay**

## **–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**
Overlay —Ä–∞–∑–¥–µ–ª –æ–≥—Ä–∞–Ω–∏—á–µ–Ω (~200MB). –°–∏–º–ª–∏–Ω–∫–∏ –ø–æ–∑–≤–æ–ª—è—é—Ç –ø–µ—Ä–µ–Ω–µ—Å—Ç–∏ –æ–±—ä–µ–º–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –Ω–∞ NVMe –±–µ–∑ –Ω–∞—Ä—É—à–µ–Ω–∏—è —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã.

## **–ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è:**

### **–ê–Ω–∞–ª–∏–∑ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è overlay:**
```bash
# –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Å–∞–º—ã–µ –æ–±—ä–µ–º–Ω—ã–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
du -sh /overlay/* 2>/dev/null | sort -hr
# –í—ã–≤–æ–¥ –ø–æ–º–æ–∂–µ—Ç –∏–¥–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ –¥–ª—è –ø–µ—Ä–µ–Ω–æ—Å–∞
```

### **–ü–µ—Ä–µ–Ω–æ—Å –∫—ç—à–∞ –ø–∞–∫–µ—Ç–æ–≤ opkg:**
```bash
# 1. –°–æ–∑–¥–∞—Ç—å —Ü–µ–ª–µ–≤—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –Ω–∞ NVMe
mkdir -p /mnt/nvme/opkg_cache
# –°–æ–∑–¥–∞–Ω–∏–µ —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏—Ö –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã

# 2. –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –∞—Ç—Ä–∏–±—É—Ç–æ–≤
cp -a /overlay/usr/lib/opkg/* /mnt/nvme/opkg_cache/
# –ö–ª—é—á -a —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –ø—Ä–∞–≤–∞, –≤–ª–∞–¥–µ–ª—å—Ü–∞, –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –º–µ—Ç–∫–∏

# 3. –£–¥–∞–ª–µ–Ω–∏–µ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
rm -rf /overlay/usr/lib/opkg
# –û—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ –º–µ—Å—Ç–∞ –≤ overlay —Ä–∞–∑–¥–µ–ª–µ

# 4. –°–æ–∑–¥–∞–Ω–∏–µ —Å–∏–º–≤–æ–ª–∏—á–µ—Å–∫–æ–π —Å—Å—ã–ª–∫–∏
ln -s /mnt/nvme/opkg_cache /overlay/usr/lib/opkg
# –°–æ–∑–¥–∞–Ω–∏–µ —Å–∏–º–ª–∏–Ω–∫–∞, —Ä–∞–∑—Ä–µ—à–∞—é—â–µ–≥–æ –¥–æ—Å—Ç—É–ø –∫ –¥–∞–Ω–Ω—ã–º –Ω–∞ NVMe
```

### **–ü–µ—Ä–µ–Ω–æ—Å Docker –¥–∞–Ω–Ω—ã—Ö (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è):**
```bash
# 1. –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–µ—Ä–≤–∏—Å–∞ Docker
/etc/init.d/docker stop
# –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –ø–µ—Ä–µ–Ω–æ—Å–µ

# 2. –ü–µ—Ä–µ–Ω–æ—Å –¥–∞–Ω–Ω—ã—Ö
mkdir -p /mnt/nvme/docker
cp -a /overlay/docker/* /mnt/nvme/docker/

# 3. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Docker
uci set docker.overlay.path='/mnt/nvme/docker'
uci commit docker
# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Docker –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ –ø—É—Ç–∏

# 4. –ó–∞–º–µ–Ω–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ —Å–∏–º–ª–∏–Ω–∫–æ–º
rm -rf /overlay/docker
ln -s /mnt/nvme/docker /overlay/docker

# 5. –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–∞
/etc/init.d/docker start
```

### **–í–∞–ª–∏–¥–∞—Ü–∏—è —Å–∏–º–ª–∏–Ω–∫–æ–≤:**
```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö —Å–∏–º–ª–∏–Ω–∫–æ–≤
ls -la /overlay/usr/lib/ | grep opkg
# –í—ã–≤–æ–¥: lrwxrwxrwx ... opkg -> /mnt/nvme/opkg_cache

# –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ —Å–∏–º–ª–∏–Ω–∫–∏ —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
file /overlay/usr/lib/opkg
# –î–æ–ª–∂–µ–Ω –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å: symbolic link to /mnt/nvme/opkg_cache
```

---

# ‚öôÔ∏è **4. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏ –±—ç–∫–∞–ø–∞**

## **–°–∏—Å—Ç–µ–º–∞ –ª–æ–≥–≥–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–∞ NVMe:**

### **–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è syslog:**
```bash
# –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —Å–∏—Å—Ç–µ–º—ã
vi /etc/config/system
# –û—Ç–∫—Ä—ã—Ç–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

# –ò–∑–º–µ–Ω–µ–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –ª–æ–≥–≥–∏—Ä–æ–≤–∞–Ω–∏—è
option log_file '/mnt/nvme/logs/system.log'
# –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –ª–æ–≥–æ–≤ –Ω–∞ NVMe
option log_size '8192'
# –£–≤–µ–ª–∏—á–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ –ª–æ–≥-–±—É—Ñ–µ—Ä–∞ –¥–æ 8MB

# –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π
/etc/init.d/log restart
# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–ª—É–∂–±—ã –ª–æ–≥–≥–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫
```

### **–ù–∞—Å—Ç—Ä–æ–π–∫–∞ logrotate:**
```bash
# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ logrotate
opkg update && opkg install logrotate
# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —É—Ç–∏–ª–∏—Ç—ã –¥–ª—è —Ä–æ—Ç–∞—Ü–∏–∏ –ª–æ–≥–æ–≤

# –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
cat > /etc/logrotate.conf << 'EOF'
/mnt/nvme/logs/*.log {
    daily
    rotate 30
    compress
    delaycompress
    missingok
    notifempty
    create 644 root root
}
EOF
# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–π —Ä–æ—Ç–∞—Ü–∏–∏ —Å —Ö—Ä–∞–Ω–µ–Ω–∏–µ–º 30 –¥–Ω–µ–π

# –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å cron
echo "0 2 * * * /usr/sbin/logrotate /etc/logrotate.conf" >> /etc/crontabs/root
# –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –∑–∞–ø—É—Å–∫ logrotate –≤ 2:00
```

## **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –±—ç–∫–∞–ø—ã –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏:**

### **–°–∫—Ä–∏–ø—Ç –±—ç–∫–∞–ø–∞:**
```bash
cat > /usr/local/bin/backup_config << 'EOF'
#!/bin/sh
# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –±—ç–∫–∞–ø –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ OpenWRT

BACKUP_DIR="/mnt/nvme/backups"
DATE=$(date +%Y%m%d_%H%M%S)
RETENTION_DAYS=30

# –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –±—ç–∫–∞–ø–æ–≤
mkdir -p "$BACKUP_DIR"

# –ë—ç–∫–∞–ø –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ sysupgrade
sysupgrade -b "$BACKUP_DIR/config_$DATE.tar.gz"
# –°–æ–∑–¥–∞–Ω–∏–µ –∞—Ä—Ö–∏–≤–∞ —Å–æ –≤—Å–µ–º–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è–º–∏

# –ë—ç–∫–∞–ø —Å–ø–∏—Å–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö –ø–∞–∫–µ—Ç–æ–≤
opkg list-installed > "$BACKUP_DIR/packages_$DATE.txt"
# –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –ø–∞–∫–µ—Ç–æ–≤ –¥–ª—è –≤–æ–∑–º–æ–∂–Ω–æ–≥–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è

# –ë—ç–∫–∞–ø fstab –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
cp /etc/config/fstab "$BACKUP_DIR/fstab_$DATE.config"
# –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

# –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –±—ç–∫–∞–ø–æ–≤
find "$BACKUP_DIR" -type f -name "*.tar.gz" -mtime +$RETENTION_DAYS -delete
find "$BACKUP_DIR" -type f -name "*.txt" -mtime +$RETENTION_DAYS -delete
find "$BACKUP_DIR" -type f -name "*.config" -mtime +$RETENTION_DAYS -delete
# –£–¥–∞–ª–µ–Ω–∏–µ –±—ç–∫–∞–ø–æ–≤ —Å—Ç–∞—Ä—à–µ 30 –¥–Ω–µ–π

# –õ–æ–≥–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
logger -t backup "Configuration backup completed: $DATE"
# –ó–∞–ø–∏—Å—å —Å–æ–±—ã—Ç–∏—è –≤ —Å–∏—Å—Ç–µ–º–Ω—ã–π –ª–æ–≥
EOF

chmod +x /usr/local/bin/backup_config
# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∞–≤ –Ω–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ
```

### **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å cron:**
```bash
# –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –±—ç–∫–∞–ø –≤ 3:00
echo "0 3 * * * /usr/local/bin/backup_config" >> /etc/crontabs/root

# –ë—ç–∫–∞–ø –ø–µ—Ä–µ–¥ –≤—ã–∫–ª—é—á–µ–Ω–∏–µ–º/–ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–æ–π
cat > /etc/rc.local << 'EOF'
#!/bin/sh
# –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –±—ç–∫–∞–ø–∞ –ø–µ—Ä–µ–¥ –≤—ã–∫–ª—é—á–µ–Ω–∏–µ–º
if [ "$1" = "stop" ]; then
    /usr/local/bin/backup_config
fi
exit 0
EOF

# –ê–∫—Ç–∏–≤–∞—Ü–∏—è cron
/etc/init.d/cron enable
/etc/init.d/cron start
# –í–∫–ª—é—á–µ–Ω–∏–µ –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫–∞ –∏ –∑–∞–ø—É—Å–∫ —Å–ª—É–∂–±—ã cron
```

## **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–æ—Å—Ç–æ—è–Ω–∏—è NVMe:**

### **SMART –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:**
```bash
# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ smartmontools
opkg update && opkg install smartmontools

# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è SMART –ø—Ä–æ–≤–µ—Ä–æ–∫
echo "0 4 * * 0 smartctl -t long /dev/nvme0n1" >> /etc/crontabs/root
# –ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω–∞—è –¥–ª–∏–Ω–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ SMART –≤ –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ –≤ 4:00

# –°–∫—Ä–∏–ø—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –∑–¥–æ—Ä–æ–≤—å—è
cat > /usr/local/bin/check_nvme_health << 'EOF'
#!/bin/sh
HEALTH=$(smartctl -H /dev/nvme0n1 | grep "SMART overall-health")
if echo "$HEALTH" | grep -q "PASSED"; then
    logger -t nvme "NVMe health: PASSED"
else
    logger -t nvme "NVMe health: FAILED - $HEALTH"
fi
EOF
chmod +x /usr/local/bin/check_nvme_health
```

### **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –¥–∏—Å–∫–∞:**
```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ –º–µ—Å—Ç–∞
cat > /usr/local/bin/check_disk_usage << 'EOF'
#!/bin/sh
THRESHOLD=90
USAGE=$(df /mnt/nvme | awk 'NR==2 {print $5}' | sed 's/%//')
if [ "$USAGE" -ge "$THRESHOLD" ]; then
    logger -t disk "NVMe usage warning: ${USAGE}%"
    # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –ª–æ–≥–æ–≤
    find /mnt/nvme/logs -name "*.log.*" -mtime +7 -delete
fi
EOF

# –ï–∂–µ—á–∞—Å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
echo "0 * * * * /usr/local/bin/check_disk_usage" >> /etc/crontabs/root
```

---

## **–ó–∞–∫–ª—é—á–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:**

1. **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ –ø–æ—Å–ª–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:**
```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
mount | grep nvme
# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏–º–ª–∏–Ω–∫–æ–≤
find /overlay -type l -exec ls -la {} \;
# –ü—Ä–æ–≤–µ—Ä–∫–∞ cron –∑–∞–¥–∞–Ω–∏–π
crontab -l
```

2. **–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–æ—Ü–µ–¥—É—Ä—ã:**
   - –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ UUID NVMe –¥–∏—Å–∫–∞: `blkid /dev/nvme0n1p1`
   - –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ —Å–æ–∑–¥–∞–Ω–Ω—ã–µ —Å–∏–º–ª–∏–Ω–∫–∏
   - –†–µ–≥—É–ª—è—Ä–Ω–æ –ø—Ä–æ–≤–µ—Ä—è–π—Ç–µ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å –±—ç–∫–∞–ø–æ–≤

3. **–ü—Ä–æ—Ü–µ–¥—É—Ä–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ—à–∏–≤–∫–∏:**
```bash
# –ü–µ—Ä–µ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º
/usr/local/bin/backup_config
# –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –±—ç–∫–∞–ø —Å–æ–∑–¥–∞–Ω

# –ü–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ NVMe
# –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–∏–º–ª–∏–Ω–∫–∏ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç—É cron –∑–∞–¥–∞–Ω–∏–π
```

–≠—Ç–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç —É—Å—Ç–æ–π—á–∏–≤—É—é —Ä–∞–±–æ—Ç—É —Å NVMe –¥–∏—Å–∫–æ–º, –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã.


